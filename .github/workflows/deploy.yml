name: AWS CI/CD Pipeline

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials (Access Key)
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-1
      
      - name: Install Tools (Terraform)
        run: |
          echo "Installing Terraform..."
        
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.8.0"
          
      - name: Install Other Tools(Mysql,Python,AWSCLI)
        run: |
          sudo apt-get update
          sudo apt-get install -y jq mysql-client 
          sudo apt-get install -y python3-pip zip 
          sudo pip3 install awscli
          
          echo "Validating tools..."
          aws --version
          jq --version
          mysql --version

      - name: Terraform Init
        run: |
          rm -rf .terraform .terraform.lock.hcl
          terraform init
        env:
          TF_VAR_db_password: ${{ secrets.DB_PASSWORD }}

      - name: Terraform Plan
        run: terraform plan
        env:
          TF_VAR_db_password: ${{ secrets.DB_PASSWORD }}
          
      - name: Terraform Apply
        run: terraform apply -auto-approve
        env:
          TF_VAR_db_password: ${{ secrets.DB_PASSWORD }}
      
      - name: Wait for EC2 user_data to complete
        run: |
          echo "Waiting 90 seconds for EC2 instance user_data (Nginx, Flyway, JRE install) to finish..."
          sleep 90
          echo "Wait complete. Proceeding with deployment."

      - name: Get Terraform Outputs
        id: tf-outputs
        run: |
          DB_HOST_ADDRESS=$(terraform output -raw database_address || echo "")
          echo "DB_HOST_ADDRESS=$DB_HOST_ADDRESS" >> $GITHUB_ENV

          S3_BUCKET_NAME=$(terraform output -raw s3_bucket_name || echo "")
          echo "S3_BUCKET_NAME=$S3_BUCKET_NAME" >> $GITHUB_ENV

          EC2_INSTANCE_ID=$(terraform output -raw ec2_instance_id || echo "")
          echo "EC2_INSTANCE_ID=$EC2_INSTANCE_ID" >> $GITHUB_ENV
          
          API_GATEWAY_URL=$(terraform output -raw backend_api_url || echo "")
          echo "API_GATEWAY_URL=$API_GATEWAY_URL" >> $GITHUB_ENV
          
          echo "--- Outputs Set ---"
          echo "S3 Bucket: $S3_BUCKET_NAME"
          echo "EC2 Instance ID: $EC2_INSTANCE_ID"
          echo "API Gateway URL: $API_GATEWAY_URL"

      - name: DB Migration (Remote Flyway via SSM)
        env:
          DB_PASS: ${{ secrets.DB_PASSWORD }}
          DB_HOST: ${{ env.DB_HOST_ADDRESS }}
          DB_NAME: user_service_db
        run: |
          echo "Running remote DB Migration using Flyway via SSM..."
          
          # Zip the directory 'db/migration/'
          zip -r flyway_migrations.zip db/migration/
          
          # 2. Transfer the zip file to EC2 using SSM (Base64 encoding)
          FLYWAY_MIGRATIONS_BASE64=$(cat flyway_migrations.zip | base64)
          
          echo "Transferring migration files to EC2..."
          aws ssm send-command \
            --instance-ids $EC2_INSTANCE_ID \
            --document-name "AWS-RunShellScript" \
            --comment "Transfer Flyway files" \
            --parameters "commands=[\"echo '$FLYWAY_MIGRATIONS_BASE64' | base64 -d > /tmp/migrations.zip\", \"unzip -o /tmp/migrations.zip -d /opt/flyway/sql/\", \"rm /tmp/migrations.zip\"]" \
            --output text

          # 3. Execute Flyway migrate command REMOTELY on EC2 via SSM
          echo "Executing Flyway migrate command on EC2..."
          aws ssm send-command \
            --instance-ids $EC2_INSTANCE_ID \
            --document-name "AWS-RunShellScript" \
            --comment "Execute Flyway Migration" \
            --parameters "commands=[\"/usr/local/bin/flyway -url='jdbc:mysql://${DB_HOST}:3306/${DB_NAME}' -user='admin' -password='${DB_PASS}' -locations=filesystem:/opt/flyway/sql/db/migration migrate\"]" \
            --output text

      - name: Deploy Application (Backend)
        run: |
          echo "Deploying app.py and restarting service using AWS Systems Manager (SSM)..."
          
          APP_PY_BASE64=$(cat app.py | base64)
          
          echo "Copying app.py to EC2..."
          aws ssm send-command \
            --instance-ids $EC2_INSTANCE_ID \
            --document-name "AWS-RunShellScript" \
            --comment "Transfer app.py" \
            --parameters "commands=[\"echo '$APP_PY_BASE64' | base64 -d > /opt/app/app.py\"]" \
            --output text
          
          echo "Restarting application service on EC2..."
          aws ssm send-command \
            --instance-ids $EC2_INSTANCE_ID \
            --document-name "AWS-RunShellScript" \
            --comment "Restart myapp.service" \
            --parameters 'commands=["sudo systemctl restart myapp.service"]' \
            --output text
      
      - name: Deploy Application (Frontend)
        run: |
          echo "Syncing frontend files to S3 bucket: $S3_BUCKET_NAME..."
          
          SAFE_API_URL=$(printf '%s\n' "$API_GATEWAY_URL" | sed 's/[&/]/\\&/g')
          sed "s#\${api_url}#$SAFE_API_URL#g" index.html > index_temp.html
          
          aws s3 cp index_temp.html s3://$S3_BUCKET_NAME/index.html --content-type "text/html"
          aws s3 sync . s3://$S3_BUCKET_NAME --exclude "*" --include "js/*"

          rm index_temp.html