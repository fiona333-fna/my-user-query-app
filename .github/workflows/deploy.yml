# .github/workflows/deploy.yml
name: Deploy Fullstack App to AWS

# 1. 触发器：
# 当 'main' 分支有新的 push 时自动运行
on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest # 使用 GitHub 提供的 Linux 服务器
    
    # 允许此作业向 AWS 写入
    permissions:
      id-token: write
      contents: read

    steps:
      # 2. 步骤一：检出代码
      # 把您仓库中的所有文件 (main.tf, app.py, index.html, js/) 下载到运行器上
      - name: Checkout repository
        uses: actions/checkout@v3

      # 3. 步骤二：配置 AWS 凭证
      # 使用官方的 'configure-aws-credentials' action
      # 它会使用您在 GitHub Secrets 中设置的密钥
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-1 # 使用您的 AWS 区域

      # 4. 步骤三：安装 Terraform
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: "1.5.0" # 您可以使用一个具体的版本

      # 5. 步骤四：运行 Terraform (初始化和部署)
      - name: Terraform Init
        run: terraform init

      - name: Terraform Validate
        run: terraform validate

      - name: Terraform Apply
        run: terraform apply -auto-approve
        # 关键：我们从 GitHub Secrets 中获取数据库密码
        # 并将其作为环境变量传递给 Terraform
        env:
          TF_VAR_db_password: ${{ secrets.DB_PASSWORD }}